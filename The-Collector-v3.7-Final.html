<!doctype html><html lang=en><head> <meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"> <title>The Collector — v3.7 (Final Release)</title> <style> :root{--bg:#0b1020;--bg2:#09142a;--panel:#0e1830;--accent:#4da8ff;--accent2:#537bff;--text:#e8f0ff;--muted:#a9b6d1;--border:#1a2b48;--shadow:0 8px 24px rgba(20,40,80,.5);--radius:14px} *{box-sizing:border-box}html,body{margin:0;height:100%;background:linear-gradient(180deg,var(--bg) 0%,var(--bg2) 100%);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif} .topbar{position:sticky;top:0;z-index:5;background:rgba(9,20,42,.8);backdrop-filter:blur(10px);display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid var(--border)} .brand{display:flex;gap:10px;align-items:center;font-weight:800;letter-spacing:.5px} .brand-logo{width:28px;height:28px;border-radius:6px;background:radial-gradient(circle at 30% 30%,var(--accent),transparent 60%),radial-gradient(circle at 70% 70%,var(--accent2),transparent 60%);box-shadow:0 0 24px rgba(77,168,255,.35) inset} .wallet{display:flex;gap:12px;align-items:center;flex-wrap:wrap} .pill{display:flex;gap:8px;align-items:center;background:var(--panel);padding:8px 10px;border:1px solid var(--border);border-radius:999px;box-shadow:var(--shadow)} .pill .ico{width:18px;height:18px;border-radius:50%} .ico-gold{background:radial-gradient(circle at 35% 35%,#fff7d1,transparent 50%),radial-gradient(circle at 60% 60%,#ffd166,transparent 50%);box-shadow:0 0 12px rgba(255,209,102,.45)} .ico-gem{background:conic-gradient(from 0deg at 50% 50%,#4da8ff,#537bff,#4da8ff);clip-path:path('M10 0 L20 10 L10 20 L0 10 Z');filter:drop-shadow(0 0 6px rgba(77,168,255,.4))} .btn{background:linear-gradient(180deg,#102044,#0c1836);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-weight:700;cursor:pointer;transition:.2s transform,.2s box-shadow} .btn:hover{transform:translateY(-1px);box-shadow:0 8px 16px rgba(0,0,0,.35)}.btn.primary{border-color:#1f3b6d}.btn.warn{border-color:#6d3b1f} .chip{padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:#0b1836;cursor:pointer}.chip.active{outline:2px solid rgba(77,168,255,.5)} .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}.container{max-width:1200px;margin:0 auto;padding:16px} .panels{background:rgba(255,255,255,.02);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden} .tabs{display:flex;gap:6px;flex-wrap:wrap;padding:8px;background:rgba(255,255,255,.03);border-bottom:1px solid var(--border)} .tab{flex:1 1 auto;text-align:center;padding:12px;border-radius:10px;cursor:pointer;border:1px solid var(--border);background:linear-gradient(180deg,#0e1a36,#0b1530);font-weight:800;letter-spacing:.2px}.tab.active{outline:2px solid rgba(77,168,255,.3)} .view{display:none;padding:16px}.view.active{display:block}.grid{display:grid;gap:12px} @media (min-width:700px){.grid.cards{grid-template-columns:repeat(3,1fr)}} @media (min-width:1000px){.grid.cards{grid-template-columns:repeat(5,1fr)}} .grid.cards.compact{grid-template-columns:repeat(2,1fr);gap:18px} @media (min-width:700px){.grid.cards.compact{grid-template-columns:repeat(4,1fr)}} @media (min-width:1000px){.grid.cards.compact{grid-template-columns:repeat(7,1fr)}} .grid.cards.compact .card{transform:scale(.8);transform-origin:top left}.grid.cards.compact .card .kvs,.grid.cards.compact .card .desc,.grid.cards.compact .card .row-actions{display:none} .grid.cards.compact .card .body{padding:8px}.grid.cards.compact .card .badge{font-size:11px;padding:3px 7px} .card{background:linear-gradient(180deg,#0c1834,#0a1530);border:1px solid var(--border);border-radius:16px;overflow:hidden;box-shadow:var(--shadow);display:flex;flex-direction:column;position:relative} .card .img{position:relative;aspect-ratio:3/4;background:#0b1736;overflow:hidden;border-radius:12px;margin:10px;border:1px solid var(--border)} .card .img img{width:100%;height:100%;object-fit:cover;display:block;transition:none} .badge{position:absolute;top:8px;left:8px;padding:4px 8px;border-radius:999px;font-size:12px;background:rgba(0,0,0,.45);border:1px solid var(--border);backdrop-filter:blur(2px)} .card .body{padding:10px;display:flex;flex-direction:column;gap:6px}.muted{color:var(--muted);font-size:.9rem} .kvs{display:flex;gap:8px;flex-wrap:wrap}.kv{background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:8px;padding:6px 8px;font-size:.85rem} .row-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}.list{display:grid;gap:10px} .list .item{display:flex;gap:10px;align-items:center;justify-content:space-between;background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:12px;padding:10px} .input,select,textarea{width:100%;background:linear-gradient(180deg,#0d1a38,#0a1430);border:1px solid var(--border);border-radius:10px;color:var(--text);padding:10px;outline:none} textarea{min-height:72px;resize:vertical}.split{display:grid;gap:14px}@media (min-width:1000px){.split{grid-template-columns:1.1fr .9fr}} .section-title{font-weight:900;margin:10px 0 6px 0;letter-spacing:.4px}.note{font-size:.9rem;color:var(--muted)} @media (max-width:700px){.tabs{position:sticky;bottom:0;z-index:6;backdrop-filter:blur(8px)}.tab{padding:10px;font-size:.95rem}} .rarity-border{position:relative;border:1px solid var(--border)}.rarity-border::before{content:"";position:absolute;inset:-3px;border-radius:16px;padding:2px;-webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude;pointer-events:none;background:var(--before-grad)} .rarity-border{box-shadow:0 0 18px var(--glowA),0 0 32px var(--glowB)}.img-gradient{position:relative} .img-gradient::before{content:"";position:absolute;inset:-3px;border-radius:12px;padding:2px;-webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude;pointer-events:none;background:var(--img-grad)} .modal{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;z-index:50}.modal.show{display:flex} .modal-content{background:#0b1634;border:1px solid var(--border);border-radius:16px;max-width:95vw;max-height:90vh;display:flex;flex-direction:column;overflow:hidden} .modal-header{display:flex;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px solid var(--border)} .modal-body{position:relative;background:#091430}.zoom-wrap{position:relative;overflow:hidden;touch-action:none;width:90vw;max-width:900px;height:70vh;margin:auto;background:#091430} .zoom-wrap img{user-select:none;pointer-events:none;position:absolute;top:0;left:0;transform-origin:0 0}.close{cursor:pointer;border:none;background:transparent;color:var(--text);font-size:1.2rem} .currency-input{max-width:120px;padding:6px 8px;border-radius:10px;border:1px solid var(--border);background:linear-gradient(180deg,#0d1a38,#0a1430);color:var(--text);font-weight:700} </style> </head><body> <div class=topbar> <div class=brand><div class=brand-logo></div><div>The Collector</div></div> <div class=wallet> <div class=pill><div class="ico ico-gold"></div><span id=gold title="Click to edit">0</span></div> <div class=pill><div class="ico ico-gem"></div><span id=gems title="Click to edit">0</span></div> <button class=btn id=btnSave>Save</button> <button class=btn id=btnExport>Export</button> <label class=btn>Import <input id=importFile type=file accept=application/json style="display:none"></label> <button class="btn warn" id=btnReset>Reset</button> </div> </div> <div class=container><div class=panels> <div class=tabs id=tabs></div> <div class=view id=view-summon></div> <div class=view id=view-collection></div> <div class=view id=view-rides></div> <div class=view id=view-estates></div> <div class=view id=view-shop></div> <div class=view id=view-database></div> <div class=view id=view-editor></div> <div class=view id=view-settings></div> </div></div> <div class=modal id=zoomModal aria-hidden=true> <div class=modal-content> <div class=modal-header><div id=zoomTitle>Zoom</div><button class=close id=zoomClose>✕</button></div> <div class=modal-body><div class=zoom-wrap id=zoomWrap><img id=zoomImg alt=Zoom></div></div> </div> </div> <script>
// === v3.7 Persistent UI State ===
function loadUIState(){
  try{
    const st = DB.settings?.uiState || {};
    Object.assign(UI, {
      colCompact: st.colCompact ?? false,
      dbCompact: st.dbCompact ?? false,
      ridesCompact: st.ridesCompact ?? false,
      estatesCompact: st.estatesCompact ?? false
    });
    Object.assign(SearchState, {
      db: st.dbSearch || '',
      col: st.colSearch || '',
      rides: st.ridesSearch || '',
      estates: st.estatesSearch || ''
    });
    window.LastSort = st.LastSort || {};
  }catch(e){console.warn('UI state load failed', e);}
}

function saveUIState(){
  DB.settings = DB.settings || {};
  DB.settings.uiState = {
    colCompact:UI.colCompact,
    dbCompact:UI.dbCompact,
    ridesCompact:UI.ridesCompact,
    estatesCompact:UI.estatesCompact,
    dbSearch:SearchState.db,
    colSearch:SearchState.col,
    ridesSearch:SearchState.rides,
    estatesSearch:SearchState.estates,
    LastSort:window.LastSort||{}
  };
  saveDB();
}

function clone(obj){return JSON.parse(JSON.stringify(obj));} const LS_KEY = 'theCollectorSaveV3_7'; const UI={colCompact:false,dbCompact:false}; var SearchState={db:'',col:'',rides:'',estates:''}; const starterDB={settings:{summonCostSingleGems:150,summonCostTenGems:1400,summonCostSingleGold:3000,summonCostTenGold:27000,maxLevel:60,levelCostBase:50, 
rarityLevelCostMul:{
"Common [T1]":1.0,
"Uncommon [T2]":1.2,
"Rare [T3]":1.5,
"Epic [T4]":1.8,
"Legendary [T5]":2.2,
"Mythic [T6]":2.8,
"Supreme [T7]":3.3,
"Arcane [T8]":3.8,
"Celestial [T9]":4.4,
"Ultimate [T10]":5.0,
"Godlike [TX]":5.7,
"Multiversal [TY]":6.6,
"Omnipotent [TZ]":7.8
},
 ascensionGemCost:200},player:{gold:30000,gems:2000,collection:[]},rarities:[ {name:"Common [T1]",rate:39,gradient:["#9a9a9a","#2f2f2f"],desc:"Mundane, grounded, ordinary presence."}, {name:"Uncommon [T2]",rate:22,gradient:["#708238","#145a32"],desc:"Natural skill and personal growth."}, {name:"Rare [T3]",rate:13,gradient:["#87ceeb","#003366"],desc:"Clarity, mastery, and refined talent."}, {name:"Epic [T4]",rate:8,gradient:["#9c5cff","#4b0082"],desc:"The spark of otherworldly power."}, {name:"Legendary [T5]",rate:6,gradient:["#ffbf00","#ffd700"],desc:"Radiance of heroes and fabled might."}, {name:"Mythic [T6]",rate:4,gradient:["#dc143c","#ff4500"],desc:"Passionate, cataclysmic strength."}, {name:"Supreme [T7]",rate:2.5,gradient:["#c0c0c0","#ffffff"],desc:"Pure, transcendent energy; myth incarnate."}, {name:"Arcane [T8]",rate:1.6,gradient:["#008080","#00ffff"],desc:"Esoteric, reality-bending phenomena."}, {name:"Celestial [T9]",rate:1.1,gradient:["#4b0082","#ff00ff"],desc:"Cosmic resonance; power of the heavens."}, {name:"Ultimate [T10]",rate:0.7,gradient:["#001f7f","#00aaff"],desc:"Stellar-scale command and cosmic shaping."}, {name:"Godlike [TX]",rate:0.4,gradient:["#ffd700","#fff8dc"],desc:"Deific dominion and rule-breaking force."}, {name:"Multiversal [TY]",rate:0.2,gradient:["#ff00ff","#00ffff"],desc:"Infinite reflections across realities."}, {name:"Omnipotent [TZ]",rate:0.1,gradient:["#000000","#ffffff"],desc:"The Alpha and Omega; all color and none."} ],characters:[ {id:"AURION",name:"Aurion, Blade of Dawn",rarity:"Legendary [T5]",world:"Eloria",tags:["Knight","Human","Light"],image:"https://images.unsplash.com/photo-1606112219348-204d7d8b94ee?q=80&w=800",desc:"A sworn protector whose blade mirrors sunrise.",stats:{STR:16,DEX:12,CON:14,INT:10,WIS:11,CHA:13}}, {id:"LYRIA",name:"Lyria the Runeseer",rarity:"Epic [T4]",world:"Eloria",tags:["Mage","Elf","Arcane"],image:"https://images.unsplash.com/photo-1549880338-65ddcdfd017b?q=80&w=800",desc:"Runes whisper secrets of forgotten gods.",stats:{STR:8,DEX:12,CON:10,INT:18,WIS:16,CHA:12}}, {id:"RAX",name:"RAX-77 Enforcer",rarity:"Rare [T3]",world:"Neonex",tags:["Android","Enforcer","Tech"],image:"https://images.unsplash.com/photo-1542751371-adc38448a05e?q=80&w=800",desc:"Industrial chassis with reprogrammable ethics.",stats:{STR:14,DEX:10,CON:16,INT:9,WIS:8,CHA:6}}, {id:"NOVA",name:"Nova Straylight",rarity:"Epic [T4]",world:"Neonex",tags:["Rogue","Human","Sniper"],image:"https://images.unsplash.com/photo-1517817748491-58e3b4079ab2?q=80&w=800",desc:"A silenced shot in the rain.",stats:{STR:9,DEX:17,CON:11,INT:13,WIS:10,CHA:12}}, {id:"BRAM",name:"Bramblekin",rarity:"Uncommon [T2]",world:"Eloria",tags:["Beast","Nature","Support"],image:"https://images.unsplash.com/photo-1506795660198-aa26cf2c9f0f?q=80&w=800",desc:"Thorny spirit that blooms under moonlight.",stats:{STR:10,DEX:12,CON:12,INT:8,WIS:14,CHA:15}} ],rides:[],estates:[],packs:[ {id:"ARC_MAGES",name:"Arcane Mages Pack",priceGems:600,priceGold:12000,tags:["Mage","Arcane"],bias:{"Supreme [T7]":1.3,"Epic [T4]":1.15},desc:"Increased chance for arcane spellcasters."}, {id:"NEO_CYBER",name:"Neon Cyber Pack",priceGems:500,priceGold:10000,tags:["Android","Tech","Neon"],bias:{"Epic [T4]":1.3,"Supreme [T7]":1.15},desc:"Cybernetics and neon-slick outlaws."} ]}; let DB=null; function loadDB(){try{const raw=localStorage.getItem(LS_KEY);DB=raw?JSON.parse(raw):clone(starterDB);saveDB()}catch(e){DB=clone(starterDB);saveDB()}} function saveDB(){localStorage.setItem(LS_KEY,JSON.stringify(DB));if(window.GRAD_CACHE)GRAD_CACHE={};renderTopbar()} function resetDB(){if(!confirm('Reset all data?'))return;DB=clone(starterDB);saveDB();routeTo('summon');renderAll()} function exportDB(){const blob=new Blob([JSON.stringify(DB,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='the-collector-v3_5.json';a.click();URL.revokeObjectURL(url)} const tabs=[{id:'summon',label:'Summon'},{id:'collection',label:'Collection'},{id:'rides',label:'Rides'},{id:'estates',label:'Estates'},{id:'shop',label:'Shop'},{id:'database',label:'Database'},{id:'editor',label:'Editor'},{id:'settings',label:'Settings'}]; function $(q,root=document){return root.querySelector(q)} function h(tag,props={},children=[]){const e=document.createElement(tag);Object.assign(e,props);if(props&&props.dataset){Object.entries(props.dataset).forEach(([k,v])=>e.dataset[k]=v)}(Array.isArray(children)?children:[children]).filter(Boolean).forEach(ch=>{if(typeof ch==='string')e.insertAdjacentHTML('beforeend',ch);else e.appendChild(ch)});return e} function initTabs(){const c=$('#tabs');c.innerHTML='';tabs.forEach(t=>{const el=document.createElement('div');el.className='tab';el.textContent=t.label;el.onclick=()=>routeTo(t.id);el.id='tab-'+t.id;c.appendChild(el)});routeTo('summon')} function routeTo(id){document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));$('#view-'+id).classList.add('active');document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));$('#tab-'+id).classList.add('active');renderView(id)} function renderAll(){['summon','collection','rides','estates','shop','database','editor','settings'].forEach(renderView)} function fmt(n){return new Intl.NumberFormat().format(n)} function rng(){return crypto.getRandomValues(new Uint32Array(1))[0]/2**32} function pickWeighted(weights){const sum=weights.reduce((a,b)=>a+b.w,0);let r=rng()*sum;for(const {item,w}of weights){if(r<w)return item;r-=w}return weights.at(-1).item} function rarityObj(name){return DB.rarities.find(r=>r.name===name)} function rarityTextStyle(r){const g=r.gradient||['#777','#555'];return `background:linear-gradient(135deg, ${g[0]}, ${g[1]}); -webkit-background-clip:text; color:transparent; text-shadow:0 0 18px ${g[0]}55`} function applyCardGradient(el,rarity){const r=rarityObj(rarity)||{gradient:['#637','#334']};const g=`linear-gradient(135deg, ${r.gradient[0]}, ${r.gradient[1]})`;el.classList.add('rarity-border');el.style.setProperty('--before-grad',g);el.style.setProperty('--glowA',r.gradient[0]+'88');el.style.setProperty('--glowB',r.gradient[1]+'66')} function applyImgGradient(el,rarity){const r=rarityObj(rarity)||{gradient:['#637','#334']};const g=`linear-gradient(135deg, ${r.gradient[0]}, ${r.gradient[1]})`;el.classList.add('img-gradient');el.style.setProperty('--img-grad',g)} function renderTopbar(){$('#gold').textContent=fmt(DB.player.gold);$('#gems').textContent=fmt(DB.player.gems)} function enableCurrencyEdit(){function attach(spanId,key){const span=document.getElementById(spanId);span.style.cursor='text';span.addEventListener('click',()=>{if(span.querySelector('input'))return;const input=document.createElement('input');input.type='number';input.min='0';input.step='1';input.value=String(DB.player[key]??0);input.className='currency-input';span.textContent='';span.appendChild(input);input.focus();input.select();function commit(){let val=Math.max(0,Math.floor(Number(input.value||0)));if(val>999999999){if(!confirm('Set '+key+' to '+val.toLocaleString()+'?')){val=DB.player[key]}}DB.player[key]=val;saveDB();span.textContent=fmt(DB.player[key])}input.addEventListener('blur',commit);input.addEventListener('keydown',e=>{if(e.key==='Enter')input.blur();if(e.key==='Escape'){span.textContent=fmt(DB.player[key])}})})}attach('gold','gold');attach('gems','gems')} function buildRatesChips(){const total=DB.rarities.reduce((a,b)=>a+Number(b.rate||0),0);const wrap=h('div',{className:'row',style:'margin:8px 0'});DB.rarities.forEach(r=>{const pct=(r.rate/total*100)||0;wrap.appendChild(h('div',{className:'chip',style:`${rarityTextStyle(r)};border-color:#ffffff22`},`${r.name} ${pct.toFixed(2)}%`))});return wrap} function poolFor(rarity,tags=null){let pool=DB.characters.filter(c=>c.rarity===rarity);if(tags&&tags.length){pool=pool.filter(c=>c.tags?.some(t=>tags.includes(t)))}return pool} function randomCharacterFromRarity(rarity,tags=null){const pool=poolFor(rarity,tags);if(pool.length===0)return null;return pool[Math.floor(rng()*pool.length)]} function rollRarity(bias=null){const weights=DB.rarities.map(r=>{let w=Number(r.rate)||0;if(bias&&bias[r.name])w*=bias[r.name];return {item:r.name,w}});return pickWeighted(weights)} function addToCollection(charId){const uid=Math.random().toString(36).slice(2)+Date.now().toString(36);const inst={id:uid,charId,level:1,ascended:0,xp:0};DB.player.collection.push(inst);return inst} function summon(count=1,currency='gems',packBias=null,packTags=null){let cost=0;if(currency==='gems')cost=(count===10?DB.settings.summonCostTenGems:DB.settings.summonCostSingleGems);else cost=(count===10?DB.settings.summonCostTenGold:DB.settings.summonCostSingleGold);if(DB.player[currency]<cost){alert('Not enough '+currency+'.');return}DB.player[currency]-=cost;const results=[];for(let i=0;i<count;i++){const rar=rollRarity(packBias);const ch=randomCharacterFromRarity(rar,packTags)||randomCharacterFromRarity(rar,null);if(ch)results.push(addToCollection(ch.id))}saveDB();renderTopbar();revealSummonResults(results)} function revealSummonResults(instances){const v=$('#view-summon');const grid=h('div',{className:'grid cards'});instances.forEach(inst=>{const ch=DB.characters.find(c=>c.id===inst.charId);grid.appendChild(characterCard(ch,inst))});v.querySelector('.summon-results').innerHTML='';v.querySelector('.summon-results').appendChild(grid)} function nextXpFor(level){return 100+Math.floor((level-1)*25)} function addExp(inst,amount){if(inst.level>=DB.settings.maxLevel){inst.xp=Math.min(inst.xp,nextXpFor(inst.level));return}inst.xp+=amount;while(inst.xp>=nextXpFor(inst.level)&&inst.level<DB.settings.maxLevel){inst.xp-=nextXpFor(inst.level);inst.level+=1}} function setLevel(uid,lvl){const inst=DB.player.collection.find(x=>x.id===uid);if(!inst)return;const L=Math.max(1,Math.min(DB.settings.maxLevel,Number(lvl)||1));inst.level=L;inst.xp=Math.min(inst.xp||0,nextXpFor(L));saveDB();renderCollection()} function maxOutLevel(uid){const inst=DB.player.collection.find(x=>x.id===uid);if(!inst)return;inst.level=DB.settings.maxLevel;inst.xp=nextXpFor(inst.level);saveDB();renderCollection()} function levelUp(uid){const inst=DB.player.collection.find(x=>x.id===uid);if(!inst)return;const ch=DB.characters.find(c=>c.id===inst.charId);const rMul=DB.settings.rarityLevelCostMul[ch.rarity]||1;const cost=Math.floor(DB.settings.levelCostBase*rMul*(1+(inst.level-1)*0.15));if(inst.level>=DB.settings.maxLevel){alert('Max level reached. Use Ascend or Max Out.');return}if(DB.player.gold<cost){alert('Not enough Gold.');return}DB.player.gold-=cost;const expGain=30+Math.floor(rng()*15);addExp(inst,expGain);saveDB();renderTopbar();renderCollection()} function ascend(uid){const inst=DB.player.collection.find(x=>x.id===uid);if(!inst)return;if(inst.level<DB.settings.maxLevel){alert('Reach max level before Ascension.');return}if(DB.player.gems<DB.settings.ascensionGemCost){alert('Not enough Gems.');return}DB.player.gems-=DB.settings.ascensionGemCost;inst.ascended+=1;inst.level=1;inst.xp=0;saveDB();renderTopbar();renderCollection()} function calcSellValue(inst){const ch=DB.characters.find(c=>c.id===inst.charId);const base=40;const rarMul=(DB.rarities.findIndex(r=>r.name===ch.rarity)+1)*12;return Math.floor(base+rarMul+inst.level*3+inst.ascended*50)} function sellInstance(uid){const i=DB.player.collection.findIndex(x=>x.id===uid);if(i<0)return;const inst=DB.player.collection[i];const goldGain=calcSellValue(inst);const ch=DB.characters.find(c=>c.id===inst.charId);if(!confirm(`Sell ${ch.name} (Lv ${inst.level}) for ${goldGain} Gold?`))return;DB.player.collection.splice(i,1);DB.player.gold+=goldGain;saveDB();renderTopbar();renderCollection()} function sellDuplicates(){const groups=new Map();DB.player.collection.forEach(inst=>{const g=groups.get(inst.charId)||[];g.push(inst);groups.set(inst.charId,g)});let toSell=[];groups.forEach(list=>{list.sort((a,b)=>(b.level-a.level)||(b.ascended-a.ascended));toSell=toSell.concat(list.slice(1))});if(toSell.length===0){alert('No duplicates to sell.');return}const totalGold=toSell.reduce((s,inst)=>s+calcSellValue(inst),0);if(!confirm(`Sell ${toSell.length} duplicates for ${fmt(totalGold)} Gold?`))return;const ids=new Set(toSell.map(x=>x.id));DB.player.collection=DB.player.collection.filter(x=>!ids.has(x.id));DB.player.gold+=totalGold;saveDB();renderTopbar();renderCollection()} function characterCard(ch,instance=null){const r=rarityObj(ch.rarity)||{gradient:['#888','#666']};const wrap=h('div',{className:'card'});applyCardGradient(wrap,ch.rarity);const imgBox=h('div',{className:'img'},[h('img',{src:ch.image,alt:ch.name,draggable:false}),h('div',{className:'badge',style:`${rarityTextStyle(r)};border-color:#ffffff22`},ch.rarity)]);applyImgGradient(imgBox,ch.rarity);imgBox.onclick=()=>openZoom(ch.name,ch.image);const statsRow=h('div',{className:'kvs'},[h('div',{className:'kv'},`STR ${ch.stats.STR}`),h('div',{className:'kv'},`DEX ${ch.stats.DEX}`),h('div',{className:'kv'},`CON ${ch.stats.CON}`),h('div',{className:'kv'},`INT ${ch.stats.INT}`),h('div',{className:'kv'},`WIS ${ch.stats.WIS}`),h('div',{className:'kv'},`CHA ${ch.stats.CHA}`)]);const expLine=instance?h('div',{className:'muted'},`Lv ${instance.level}${instance.ascended?' ✦'+instance.ascended:''} — ${instance.xp||0}/${nextXpFor(instance.level)} EXP`):null;const levelRow=instance?h('div',{className:'row',style:'align-items:center'},[h('label',{className:'muted'},'Level:'),h('input',{className:'input',type:'number',min:1,max:DB.settings.maxLevel,value:instance.level,style:'max-width:120px',oninput:(e)=>setLevel(instance.id,e.target.value)}),h('button',{className:'btn',onclick:()=>maxOutLevel(instance.id)},'Max Out')]):null;const descEl=h('div',{className:'muted desc'},ch.desc||'');const actions=instance?h('div',{className:'row-actions'},[h('button',{className:'btn primary',onclick:()=>levelUp(instance.id)},'Train (+EXP)'),h('button',{className:'btn',onclick:()=>ascend(instance.id)},'Ascend'),h('button',{className:'btn warn',onclick:()=>sellInstance(instance.id)},'Sell'),h('button',{className:'btn',onclick:()=>openCharacterEditor(ch)},'Edit')]):h('div',{className:'row-actions'},[h('button',{className:'btn',onclick:()=>openCharacterEditor(ch)},'Edit')]);const body=h('div',{className:'body'},[h('div',{innerHTML:`<strong style="${rarityTextStyle(r)}">${ch.name}</strong>`}),h('div',{className:'muted'},`${ch.world} · ${(ch.tags||[]).join(', ')}`),statsRow,expLine,levelRow,descEl,actions]);wrap.appendChild(imgBox);wrap.appendChild(body);return wrap} function parseQuery(q){return q.split(',').map(s=>s.trim().toLowerCase()).filter(Boolean)} function characterMatches(c,queryParts,filter={}){const hay=(c.name+' '+(c.world||'')+' '+c.rarity+' '+(c.tags||[]).join(' ')).toLowerCase();const passQuery=queryParts.length===0||queryParts.some(p=>hay.includes(p));const passRarity=!filter.rarity||c.rarity===filter.rarity;const passWorld=!filter.world||(c.world||'').toLowerCase().includes(filter.world.toLowerCase());const passTag=!filter.tag||(c.tags||[]).includes(filter.tag);return passQuery&&passRarity&&passWorld&&passTag} function sortChars(arr,key){const idxByRarity=Object.fromEntries(DB.rarities.map((r,i)=>[r.name,i]));return arr.slice().sort((a,b)=>{if(key==='Name')return a.name.localeCompare(b.name);if(key==='Rarity')return idxByRarity[a.rarity]-idxByRarity[b.rarity];return 0})} function sortInstances(arr,key){const idxByRarity=Object.fromEntries(DB.rarities.map((r,i)=>[r.name,i]));return arr.slice().sort((a,b)=>{if(key==='Name'){const A=DB.characters.find(c=>c.id===a.charId)?.name||'';const B=DB.characters.find(c=>c.id===b.charId)?.name||'';return A.localeCompare(B)}if(key==='Rarity'){const A=DB.characters.find(c=>c.id===a.charId)?.rarity||'';const B=DB.characters.find(c=>c.id===b.charId)?.rarity||'';return idxByRarity[A]-idxByRarity[B]}if(key==='Level')return (b.level)-(a.level);if(key==='Ascension')return (b.ascended)-(a.ascended);return 0})} function renderDatabase(){
  const v=$('#view-database');
  const existingSearch=v.querySelector('#dbQuery');
  if(!existingSearch){
    v.innerHTML='';
    const tools=h('div',{className:'row',style:'margin:8px 0'},[
      h('input',{className:'input',placeholder:'Search name, tag, world, rarity (comma = OR)',id:'dbQuery',value:(SearchState?.db||''),oninput:(e)=>{SearchState.db=e.target.value;debouncedRender('db')}}),
      ( ()=>{ const sel=h('select',{className:'input',id:'dbSort',onchange:renderDatabase},[h('option',{innerText:'Name'}),h('option',{innerText:'Rarity'}),h('option',{innerText:'World'}),h('option',{innerText:'Tag Count'})]); return sel; } )(),
      h('button',{className:'btn chip',id:'btnDbCompact',onclick:()=>{UI.dbCompact=!UI.dbCompact;renderDatabase()}},'Compact View'),
      h('div',{style:'margin-left:auto'}),
      h('button',{className:'btn primary',onclick:()=>editCharacter(-1)},'Add Character')
    ]);
    if(UI.dbCompact) tools.querySelector('#btnDbCompact').classList.add('active');
    const filters=h('div',{className:'row',style:'margin:8px 0'},[
      h('div',{},'Filter:'),
      ( ()=>{
        const d=h('div',{className:'row'});
        const rsel=h('select',{className:'input',id:'dbFRarity',onchange:renderDatabase},[h('option',{value:'',innerText:'Any Rarity'})].concat(DB.rarities.map(r=>h('option',{value:r.name,innerText:r.name}))));
        const winput=h('input',{className:'input',id:'dbFWorld',placeholder:'World contains...',oninput:renderDatabase});
        d.appendChild(rsel); d.appendChild(winput); return d;
      } )()
    ]);
    v.appendChild(tools);
    v.appendChild(filters);
  } else {
    const gridOld=v.querySelector('.grid.cards');
    if(gridOld) gridOld.remove();
  }
  const q=(SearchState.db||'').trim();
  const qp=parseQuery(q);
  const filter={rarity:($('#dbFRarity')?.value||''),world:($('#dbFWorld')?.value||'')};
  const sortKey=($('#dbSort')?.value||'Name');
  let chars=DB.characters.filter(c=>characterMatches(c,qp,filter));
  chars=sortChars(chars,sortKey);
  const grid=h('div',{className:'grid cards'+(UI.dbCompact?' compact':'')});
  chars.forEach(c=>grid.appendChild(characterCard(c,null)));
  v.appendChild(grid);
}

function renderCollection(){
  const v=$('#view-collection');
  const existingSearch=v.querySelector('#colQuery');
  if(!existingSearch){
    v.innerHTML='';
    const tools=h('div',{className:'row',style:'margin:8px 0'},[
      h('input',{className:'input',placeholder:'Search your collection (comma = OR)',id:'colQuery',value:(SearchState?.col||''),oninput:(e)=>{SearchState.col=e.target.value;debouncedRender('col')}}),
      ( ()=>{ const sel=h('select',{className:'input',id:'colSort',onchange:renderCollection},[h('option',{innerText:'Name'}),h('option',{innerText:'Rarity'}),h('option',{innerText:'Level'}),h('option',{innerText:'Ascension'}),h('option',{innerText:'World'}),h('option',{innerText:'Tag Count'})]); return sel; } )(),
      h('button',{className:'btn chip',id:'btnColCompact',onclick:()=>{UI.colCompact=!UI.colCompact;renderCollection()}},'Compact View'),
      h('div',{style:'margin-left:auto'}),
      h('button',{className:'btn warn',onclick:sellDuplicates},'Sell Duplicates')
    ]);
    if(UI.colCompact) tools.querySelector('#btnColCompact').classList.add('active');
    v.appendChild(tools);
  } else {
    const gridOld=v.querySelector('.grid.cards');
    if(gridOld) gridOld.remove();
  }
  const qp=parseQuery(SearchState.col||'');
  const sortKey=($('#colSort')?.value||'Name');
  let inst=DB.player.collection.slice();
  inst=inst.filter(ins=>{const ch=DB.characters.find(c=>c.id===ins.charId); if(!ch) return false; return characterMatches(ch,qp,{});});
  inst=sortInstances(inst,sortKey);
  const grid=h('div',{className:'grid cards'+(UI.colCompact?' compact':'')});
  inst.forEach(ins=>{const ch=DB.characters.find(c=>c.id===ins.charId); if(ch) grid.appendChild(characterCard(ch,ins));});
  v.appendChild(grid);
}


// ===== Rides & Estates (v3.6) =====
function rideMatches(r, queryParts, filter={}){
  const hay=(r.name+' '+(r.type||'')+' '+(r.rarity||'')).toLowerCase();
  const passQuery=queryParts.length===0||queryParts.some(p=>hay.includes(p));
  const passRarity=!filter.rarity || r.rarity===filter.rarity;
  return passQuery && passRarity;
}
function estateMatches(ei, queryParts, filter={}){
  const hay=(ei.name+' '+(ei.region||'')+' '+(ei.rarity||'')).toLowerCase();
  const passQuery=queryParts.length===0||queryParts.some(p=>hay.includes(p));
  const passRarity=!filter.rarity || ei.rarity===filter.rarity;
  return passQuery && passRarity;
}
function sortRides(arr,key){
  const idxByRarity=Object.fromEntries(DB.rarities.map((r,i)=>[r.name,i]));
  return arr.slice().sort((a,b)=>{
    if(key==='Name') return (a.name||'').localeCompare(b.name||'');
    if(key==='Rarity') return (idxByRarity[a.rarity]??0)-(idxByRarity[b.rarity]??0);
    if(key==='Speed') return (b.speed||0)-(a.speed||0);
    if(key==='Type') return (a.type||'').localeCompare(b.type||'');
    return 0;
  });
}
function sortEstates(arr,key){
  const idxByRarity=Object.fromEntries(DB.rarities.map((r,i)=>[r.name,i]));
  return arr.slice().sort((a,b)=>{
    if(key==='Name') return (a.name||'').localeCompare(b.name||'');
    if(key==='Rarity') return (idxByRarity[a.rarity]??0)-(idxByRarity[b.rarity]??0);
    if(key==='Capacity') return (b.capacity||0)-(a.capacity||0);
    if(key==='Region') return (a.region||'').localeCompare(b.region||'');
    return 0;
  });
}
function rideCard(r){
  const rr=rarityObj(r.rarity)||{gradient:['#777','#444']};
  const wrap=h('div',{className:'card'});
  applyCardGradient(wrap,r.rarity);
  const imgBox=h('div',{className:'img'},[h('img',{src:r.image||'',alt:r.name||'Ride',draggable:false}),h('div',{className:'badge',style:`${rarityTextStyle(rr)};border-color:#ffffff22`},r.rarity||'—')]);
  applyImgGradient(imgBox,r.rarity);
  imgBox.onclick=()=>r.image&&openZoom(r.name,r.image);
  const body=h('div',{className:'body'},[
    h('div',{innerHTML:`<strong style="${rarityTextStyle(rr)}">${r.name||'Unnamed Ride'}</strong>`}),
    h('div',{className:'muted'},`${r.type||'—'} · Speed: ${r.speed||0}`),
    h('div',{className:'muted desc'},r.desc||''),
    h('div',{className:'row-actions'},[
      h('button',{className:'btn',onclick:()=>openRideEditor(r)},'Edit'),
      h('button',{className:'btn warn',onclick:()=>{const i=DB.rides.findIndex(x=>x.id===r.id); if(i>=0&&confirm('Delete ride?')){DB.rides.splice(i,1);saveDB();renderRides();}}},'Delete')
    ])
  ]);
  wrap.appendChild(imgBox); wrap.appendChild(body);
  return wrap;
}
function estateCard(ei){
  const rr=rarityObj(ei.rarity)||{gradient:['#777','#444']};
  const wrap=h('div',{className:'card'});
  applyCardGradient(wrap,ei.rarity);
  const imgBox=h('div',{className:'img'},[h('img',{src:ei.image||'',alt:ei.name||'Estate',draggable:false}),h('div',{className:'badge',style:`${rarityTextStyle(rr)};border-color:#ffffff22`},ei.rarity||'—')]);
  applyImgGradient(imgBox,ei.rarity);
  imgBox.onclick=()=>ei.image&&openZoom(ei.name,ei.image);
  const body=h('div',{className:'body'},[
    h('div',{innerHTML:`<strong style="${rarityTextStyle(rr)}">${ei.name||'Unnamed Estate'}</strong>`}),
    h('div',{className:'muted'},`${ei.region||'—'} · Capacity: ${ei.capacity||0}`),
    h('div',{className:'muted desc'},ei.desc||''),
    h('div',{className:'row-actions'},[
      h('button',{className:'btn',onclick:()=>openEstateEditor(ei)},'Edit'),
      h('button',{className:'btn warn',onclick:()=>{const i=DB.estates.findIndex(x=>x.id===ei.id); if(i>=0&&confirm('Delete estate?')){DB.estates.splice(i,1);saveDB();renderEstates();}}},'Delete')
    ])
  ]);
  wrap.appendChild(imgBox); wrap.appendChild(body);
  return wrap;
}
function openRideEditor(objOrNull){
  let r=objOrNull?clone(objOrNull):{id:'',name:'',rarity:DB.rarities[0]?.name||'Common [T1]',type:'',speed:0,image:'',desc:''};
  const form=h('div',{},[
    labelInput('ID',r.id,v=>r.id=v.toUpperCase()),
    labelInput('Name',r.name,v=>r.name=v),
    ( ()=>{const sel=h('select',{className:'input',value:r.rarity,onchange:e=>r.rarity=e.target.value},DB.rarities.map(rr=>h('option',{value:rr.name,innerText:rr.name}))); sel.value=r.rarity; return h('div',{},[h('label',{className:'muted'},'Rarity'),sel])})(),
    labelInput('Type',r.type||'',v=>r.type=v),
    labelInput('Speed',r.speed||0,v=>r.speed=Number(v),'number'),
    labelInput('Image URL',r.image||'',v=>r.image=v),
    h('div',{className:'note'},'Tip: paste any image URL. Tap preview to zoom.'),
    ( ()=>{const preview=h('div',{className:'img',style:'max-width:240px;border-radius:12px;overflow:hidden;border:1px solid var(--border);margin:8px 0;cursor:zoom-in'},[h('img',{src:r.image||'',alt:'preview'})]); preview.onclick=()=>r.image&&openZoom(r.name,r.image); return preview})(),
    labelInput('Description',r.desc||'',v=>r.desc=v),
    h('div',{className:'row'},[
      h('button',{className:'btn primary',onclick:()=>{const i=DB.rides.findIndex(x=>x.id===r.id); if(i>=0) DB.rides[i]=r; else DB.rides.push(r); saveDB();renderRides(); alert('Saved ride.');}},'Save'),
      h('button',{className:'btn',onclick:()=>renderRides()},'Close')
    ])
  ]);
  let container='ridesRight'; if(!document.getElementById(container)){const panel=h('div',{className:'card',id:container});$('#view-rides').appendChild(panel)}
  swapPanel(container,form,'Ride Editor');
}
function openEstateEditor(objOrNull){
  let e=objOrNull?clone(objOrNull):{id:'',name:'',rarity:DB.rarities[0]?.name||'Common [T1]',region:'',capacity:0,image:'',desc:''};
  const form=h('div',{},[
    labelInput('ID',e.id,v=>e.id=v.toUpperCase()),
    labelInput('Name',e.name,v=>e.name=v),
    ( ()=>{const sel=h('select',{className:'input',value:e.rarity,onchange:ev=>e.rarity=ev.target.value},DB.rarities.map(rr=>h('option',{value:rr.name,innerText:rr.name}))); sel.value=e.rarity; return h('div',{},[h('label',{className:'muted'},'Rarity'),sel])})(),
    labelInput('Region',e.region||'',v=>e.region=v),
    labelInput('Capacity',e.capacity||0,v=>e.capacity=Number(v),'number'),
    labelInput('Image URL',e.image||'',v=>e.image=v),
    h('div',{className:'note'},'Tip: paste any image URL. Tap preview to zoom.'),
    ( ()=>{const preview=h('div',{className:'img',style:'max-width:240px;border-radius:12px;overflow:hidden;border:1px solid var(--border);margin:8px 0;cursor:zoom-in'},[h('img',{src:e.image||'',alt:'preview'})]); preview.onclick=()=>e.image&&openZoom(e.name,e.image); return preview})(),
    labelInput('Description',e.desc||'',v=>e.desc=v),
    h('div',{className:'row'},[
      h('button',{className:'btn primary',onclick:()=>{const i=DB.estates.findIndex(x=>x.id===e.id); if(i>=0) DB.estates[i]=e; else DB.estates.push(e); saveDB();renderEstates(); alert('Saved estate.');}},'Save'),
      h('button',{className:'btn',onclick:()=>renderEstates()},'Close')
    ])
  ]);
  let container='estatesRight'; if(!document.getElementById(container)){const panel=h('div',{className:'card',id:container});$('#view-estates').appendChild(panel)}
  swapPanel(container,form,'Estate Editor');
}
function renderRides(){
  const v=$('#view-rides');
  const existing=v.querySelector('#rideQuery');
  if(!existing){
    v.innerHTML='';
    const tools=h('div',{className:'row',style:'margin:8px 0'},[
      h('input',{className:'input',placeholder:'Search rides (name,type)',id:'rideQuery',value:(SearchState?.rides||''),oninput:(e)=>{SearchState.rides=e.target.value;debouncedRender('rides')}}),
      ( ()=>{ const sel=h('select',{className:'input',id:'rideSort',onchange:renderRides},[h('option',{innerText:'Name'}),h('option',{innerText:'Rarity'}),h('option',{innerText:'Speed'}),h('option',{innerText:'Type'})]); return sel; } )(),
      h('div',{style:'margin-left:auto'}),
      h('button',{className:'btn primary',onclick:()=>openRideEditor(null)},'Add Ride')
    ]);
    const filters=h('div',{className:'row',style:'margin:8px 0'},[
      h('div',{},'Filter:'),
      ( ()=>{ const d=h('div',{className:'row'});
        const rsel=h('select',{className:'input',id:'rideFRarity',onchange:renderRides},[h('option',{value:'',innerText:'Any Rarity'})].concat(DB.rarities.map(r=>h('option',{value:r.name,innerText:r.name}))));
        d.appendChild(rsel); return d; } )()
    ]);
    v.appendChild(tools); v.appendChild(filters);
  } else {
    const gridOld=v.querySelector('.grid.cards'); if(gridOld) gridOld.remove();
  }
  const qp=parseQuery(SearchState.rides||'');
  const filter={rarity:($('#rideFRarity')?.value||'')};
  const sortKey=($('#rideSort')?.value||'Name');
  let arr=DB.rides.filter(r=>rideMatches(r,qp,filter));
  arr=sortRides(arr,sortKey);
  const grid=h('div',{className:'grid cards'+(UI.dbCompact?' compact':'')});
  arr.forEach(r=>grid.appendChild(rideCard(r)));
  v.appendChild(grid);
}
function renderEstates(){
  const v=$('#view-estates');
  const existing=v.querySelector('#estateQuery');
  if(!existing){
    v.innerHTML='';
    const tools=h('div',{className:'row',style:'margin:8px 0'},[
      h('input',{className:'input',placeholder:'Search estates (name,region)',id:'estateQuery',value:(SearchState?.estates||''),oninput:(e)=>{SearchState.estates=e.target.value;debouncedRender('estates')}}),
      ( ()=>{ const sel=h('select',{className:'input',id:'estateSort',onchange:renderEstates},[h('option',{innerText:'Name'}),h('option',{innerText:'Rarity'}),h('option',{innerText:'Region'}),h('option',{innerText:'Capacity'})]); return sel; } )(),
      h('div',{style:'margin-left:auto'}),
      h('button',{className:'btn primary',onclick:()=>openEstateEditor(null)},'Add Estate')
    ]);
    const filters=h('div',{className:'row',style:'margin:8px 0'},[
      h('div',{},'Filter:'),
      ( ()=>{ const d=h('div',{className:'row'});
        const rsel=h('select',{className:'input',id:'estateFRarity',onchange:renderEstates},[h('option',{value:'',innerText:'Any Rarity'})].concat(DB.rarities.map(r=>h('option',{value:r.name,innerText:r.name}))));
        d.appendChild(rsel); return d; } )()
    ]);
    v.appendChild(tools); v.appendChild(filters);
  } else {
    const gridOld=v.querySelector('.grid.cards'); if(gridOld) gridOld.remove();
  }
  const qp=parseQuery(SearchState.estates||'');
  const filter={rarity:($('#estateFRarity')?.value||'')};
  const sortKey=($('#estateSort')?.value||'Name');
  let arr=DB.estates.filter(ei=>estateMatches(ei,qp,filter));
  arr=sortEstates(arr,sortKey);
  const grid=h('div',{className:'grid cards'+(UI.dbCompact?' compact':'')});
  arr.forEach(ei=>grid.appendChild(estateCard(ei)));
  v.appendChild(grid);
}

function renderShop(){const v=$('#view-shop');v.innerHTML='';const buy=h('div',{className:'card'},h('div',{className:'body'},[h('div',{className:'section-title'},'Buy Packs'),h('div',{className:'list'},DB.packs.map(p=>h('div',{className:'item'},[h('div',{},[h('div',{innerHTML:`<strong>${p.name}</strong>`}),h('div',{className:'note'},p.desc||''),h('div',{className:'note'},'Tags: '+(p.tags||[]).join(', ')),h('div',{className:'note'},'Bias: '+(Object.entries(p.bias||{}).map(([k,v])=>`${k}×${v}`).join(' ')||'—'))]),h('div',{className:'row'},[h('div',{className:'kv'},`💎 ${fmt(p.priceGems)} or 🪙 ${fmt(p.priceGold||0)}`),h('button',{className:'btn primary',onclick:()=>summon(10,'gems',p.bias,p.tags)},'10x (Gems)'),h('button',{className:'btn',onclick:()=>summon(10,'gold',p.bias,p.tags)},'10x (Coins)')])])))]));const edit=h('div',{className:'card'},h('div',{className:'body'},[h('div',{className:'section-title'},'🛠️ Manage Packs'),h('div',{className:'list'},DB.packs.map((p,i)=>h('div',{className:'item'},[h('div',{},[h('div',{innerHTML:`<strong>${p.name}</strong>`}),h('div',{className:'note'},`Gems: ${p.priceGems} · Coins: ${p.priceGold||0}`)]),h('div',{className:'row'},[h('button',{className:'btn',onclick:()=>editPack(i)},'Edit'),h('button',{className:'btn warn',onclick:()=>{if(confirm('Delete pack?')){DB.packs.splice(i,1);saveDB();renderShop()}}},'Delete')])]))),h('button',{className:'btn primary',onclick:()=>editPack(-1)},'Add Pack')]));v.appendChild(h('div',{className:'grid',style:'grid-template-columns:1fr'},[buy,edit]))} function renderEditor(){const v=$('#view-editor');v.innerHTML='';const left=h('div',{className:'grid',style:'grid-template-columns:1fr'});left.appendChild(editorRarities());const wrap=h('div',{className:'split'});wrap.appendChild(left);const info=h('div',{className:'card'},h('div',{className:'body'},[h('div',{className:'section-title'},'Editor Scope'),h('div',{className:'note'},'Characters are managed in the Database tab. Packs are editable in the Shop.') ]));wrap.appendChild(info);v.appendChild(wrap)} function editorRarities(){const card=h('div',{className:'card'});const list=h('div',{className:'list'});DB.rarities.forEach((r,i)=>{list.appendChild(h('div',{className:'item'},[h('div',{},[h('div',{innerHTML:`<strong style="${rarityTextStyle(r)}">${r.name}</strong>`}),h('div',{className:'note'},`Rate: ${r.rate}% · ${r.desc||''}`)]),h('div',{className:'row'},[h('button',{className:'btn',onclick:()=>editRarity(i)},'Edit'),h('button',{className:'btn warn',onclick:()=>{if(confirm('Delete rarity?')){DB.rarities.splice(i,1);saveDB();renderEditor()}}},'Delete')])]))});const add=h('button',{className:'btn primary',onclick:()=>editRarity(-1)},'Add Rarity');card.appendChild(h('div',{className:'body'},[h('div',{className:'section-title'},'Rarities'),list,add]));return card} function labelInput(label,value,oninput,type='text'){const id='i'+Math.random().toString(36).slice(2,8);return h('div',{},[h('label',{for:id,className:'muted'},label),type==='color'?h('input',{id,type:'color',className:'input',value,oninput:e=>oninput(e.target.value)}):(type==='number'||typeof value==='number')?h('input',{id,type:'number',className:'input',value,oninput:e=>oninput(e.target.value)}):h('input',{id,type,className:'input',value,oninput:e=>oninput(e.target.value)})])} function swapPanel(containerId,content,title){const cont=document.getElementById(containerId);cont.innerHTML='';cont.appendChild(h('div',{className:'body'},[h('div',{className:'section-title'},title),content]))} function editRarity(index){const r=index>=0?clone(DB.rarities[index]):{name:'',rate:1,gradient:['#888','#555'],desc:''};const form=h('div',{},[labelInput('Name',r.name,v=>r.name=v),labelInput('Rate (%)',r.rate,v=>r.rate=Number(v),'number'),labelInput('Gradient Start',r.gradient[0],v=>r.gradient[0]=v,'color'),labelInput('Gradient End',r.gradient[1],v=>r.gradient[1]=v,'color'),labelInput('Description',r.desc,v=>r.desc=v),h('div',{className:'row'},[h('button',{className:'btn primary',onclick:()=>{if(index>=0)DB.rarities[index]=r;else DB.rarities.push(r);saveDB();renderEditor();alert('Saved rarity.')}},'Save'),h('button',{className:'btn',onclick:()=>renderEditor()},'Cancel')])]);const temp=h('div',{id:'rarityPanel',className:'card'});$('#view-editor').appendChild(temp);swapPanel('rarityPanel',form,'Rarity Editor')} function editPack(index){const p=index>=0?clone(DB.packs[index]):{id:'',name:'',priceGems:400,priceGold:8000,tags:[],desc:'',bias:{}};const form=h('div',{},[labelInput('ID',p.id,v=>p.id=v.toUpperCase()),labelInput('Name',p.name,v=>p.name=v),labelInput('Price (Gems)',p.priceGems,v=>p.priceGems=Number(v),'number'),labelInput('Price (Coins)',p.priceGold||0,v=>p.priceGold=Number(v),'number'),labelInput('Tags (comma)',p.tags.join(','),v=>p.tags=v.split(',').map(s=>s.trim()).filter(Boolean)),labelInput('Bias (JSON rarity->multiplier)',JSON.stringify(p.bias),v=>{try{p.bias=JSON.parse(v)}catch(e){alert('Invalid JSON for bias')}}),labelInput('Description',p.desc,v=>p.desc=v),h('div',{className:'row'},[h('button',{className:'btn primary',onclick:()=>{if(index>=0)DB.packs[index]=p;else DB.packs.push(p);saveDB();renderShop();alert('Saved pack.')}},'Save'),h('button',{className:'btn',onclick:()=>renderShop()},'Cancel')])]);const panel=h('div',{className:'card',id:'shopRight'});$('#view-shop').appendChild(panel);swapPanel('shopRight',form,'Pack Editor')} function openCharacterEditor(indexOrObj){let c,index;if(typeof indexOrObj==='number'){index=indexOrObj;c=index>=0?clone(DB.characters[index]):{id:'',name:'',rarity:DB.rarities[0]?.name||'Common',world:'',tags:[],image:'',desc:'',stats:{STR:10,DEX:10,CON:10,INT:10,WIS:10,CHA:10}}}else{c=clone(indexOrObj);index=DB.characters.findIndex(x=>x.id===c.id)}const form=h('div',{},[labelInput('ID',c.id,v=>c.id=v.toUpperCase()),labelInput('Name',c.name,v=>c.name=v),(()=>{const select=h('select',{className:'input',value:c.rarity,onchange:e=>c.rarity=e.target.value},DB.rarities.map(r=>h('option',{value:r.name,innerText:r.name})));select.value=c.rarity;return h('div',{},[h('label',{className:'muted'},'Rarity'),select])})(),labelInput('World',c.world||'',v=>c.world=v),labelInput('Tags (comma)',c.tags.join(','),v=>c.tags=v.split(',').map(s=>s.trim()).filter(Boolean)),labelInput('Image URL',c.image,v=>c.image=v),h('div',{className:'note'},'Tip: paste any image URL. Tap preview to zoom.'),(()=>{const preview=h('div',{className:'img',style:'max-width:240px;border-radius:12px;overflow:hidden;border:1px solid var(--border);margin:8px 0;cursor:zoom-in'},[h('img',{src:c.image||'',alt:'preview'})]);preview.onclick=()=>c.image&&openZoom(c.name,c.image);return preview})(),h('div',{className:'grid',style:'grid-template-columns:repeat(3,1fr);gap:8px'},Object.keys(c.stats).map(k=>labelInput(k,c.stats[k],v=>c.stats[k]=Number(v),'number'))),labelInput('Description',c.desc,v=>c.desc=v),h('div',{className:'row'},[h('button',{className:'btn primary',onclick:()=>{if(index>=0)DB.characters[index]=c;else DB.characters.push(c);saveDB();renderDatabase();renderCollection();alert('Saved character.')}},'Save'),h('button',{className:'btn warn',onclick:()=>{if(index>=0&&confirm('Delete character?')){DB.characters.splice(index,1);saveDB();renderDatabase();renderCollection()}}},'Delete'),h('button',{className:'btn',onclick:()=>{renderDatabase();renderCollection()}},'Close')])]);let containerId=document.getElementById('view-database').classList.contains('active')?'dbRight':'colRight';if(!document.getElementById(containerId)){const panel=h('div',{className:'card',id:containerId});const parent=containerId==='dbRight'?$('#view-database'):$('#view-collection');parent.appendChild(panel)}swapPanel(containerId,form,'Character Editor')} function editCharacter(index){openCharacterEditor(index)} function renderSettings(){const v=$('#view-settings');v.innerHTML='';const s=DB.settings;const form=h('div',{className:'card'},h('div',{className:'body'},[h('div',{className:'section-title'},'Summon Costs'),labelInput('Single (Gems)',s.summonCostSingleGems,v=>s.summonCostSingleGems=Number(v),'number'),labelInput('10x (Gems)',s.summonCostTenGems,v=>s.summonCostTenGems=Number(v),'number'),labelInput('Single (Coins)',s.summonCostSingleGold,v=>s.summonCostSingleGold=Number(v),'number'),labelInput('10x (Coins)',s.summonCostTenGold,v=>s.summonCostTenGold=Number(v),'number'),h('div',{className:'section-title'},'Level & Ascension'),labelInput('Max Level',s.maxLevel,v=>s.maxLevel=Number(v),'number'),labelInput('Level Cost Base',s.levelCostBase,v=>s.levelCostBase=Number(v),'number'),labelInput('Ascension Gem Cost',s.ascensionGemCost,v=>s.ascensionGemCost=Number(v),'number'),h('div',{className:'row'},[h('button',{className:'btn primary',onclick:()=>{saveDB();alert('Saved settings.')}},'Save Settings'),h('button',{className:'btn warn',onclick:resetDB},'Reset Game')]) ]));v.appendChild(form)} function renderSummon(){const v=$('#view-summon');v.innerHTML='';const card=h('div',{className:'card'});const body=h('div',{className:'body'});body.appendChild(h('div',{className:'section-title'},'Rarity Rates'));body.appendChild(buildRatesChips());body.appendChild(h('div',{className:'row',style:'margin-top:10px'},[h('button',{className:'btn primary',onclick:()=>summon(1,'gems')},`Gem Summon (💎${DB.settings.summonCostSingleGems})`),h('button',{className:'btn primary',onclick:()=>summon(10,'gems')},`Gem Summon x10 (💎${DB.settings.summonCostTenGems})`),h('button',{className:'btn',onclick:()=>summon(1,'gold')},`Coin Summon (🪙${DB.settings.summonCostSingleGold})`),h('button',{className:'btn',onclick:()=>summon(10,'gold')},`Coin Summon x10 (🪙${DB.settings.summonCostTenGold})`)]));body.appendChild(h('div',{className:'section-title'},'Results'));body.appendChild(h('div',{className:'summon-results'}));card.appendChild(body);v.appendChild(card)} let zoomState={scale:1,x:0,y:0,lastX:0,lastY:0,dragging:false,startDist:0,startScale:1}; function openZoom(title,url){$('#zoomTitle').textContent=title||'Zoom';const img=$('#zoomImg');img.src=url;zoomState={scale:1,x:0,y:0,lastX:0,lastY:0,dragging:false,startDist:0,startScale:1};applyZoomTransform();$('#zoomModal').classList.add('show');$('#zoomModal').setAttribute('aria-hidden','false')} function closeZoom(){$('#zoomModal').classList.remove('show');$('#zoomModal').setAttribute('aria-hidden','true')} function applyZoomTransform(){const img=$('#zoomImg');img.style.transform=`translate(${zoomState.x}px, ${zoomState.y}px) scale(${zoomState.scale})`} function onWheel(e){e.preventDefault();const delta=-e.deltaY;const factor=delta>0?1.1:0.9;zoomState.scale=Math.min(8,Math.max(0.5,zoomState.scale*factor));applyZoomTransform()} function onPointerDown(e){zoomState.dragging=true;zoomState.lastX=e.clientX;zoomState.lastY=e.clientY} function onPointerMove(e){if(!zoomState.dragging)return;const dx=e.clientX-zoomState.lastX,dy=e.clientY-zoomState.lastY;zoomState.x+=dx;zoomState.y+=dy;zoomState.lastX=e.clientX;zoomState.lastY=e.clientY;applyZoomTransform()} function onPointerUp(){zoomState.dragging=false} function dist(a,b){const dx=a.clientX-b.clientX,dy=a.clientY-b.clientY;return Math.hypot(dx,dy)} function onTouch(e){if(e.touches.length===2){e.preventDefault();const d=dist(e.touches[0],e.touches[1]);if(!zoomState.startDist){zoomState.startDist=d;zoomState.startScale=zoomState.scale}const f=d/zoomState.startDist;zoomState.scale=Math.min(8,Math.max(0.5,zoomState.startScale*f));applyZoomTransform()}} function bindZoom(){const wrap=$('#zoomWrap');wrap.addEventListener('wheel',onWheel,{passive:false});wrap.addEventListener('pointerdown',onPointerDown);window.addEventListener('pointermove',onPointerMove);window.addEventListener('pointerup',onPointerUp);wrap.addEventListener('touchmove',onTouch,{passive:false});$('#zoomClose').onclick=closeZoom;$('#zoomModal').addEventListener('click',(e)=>{if(e.target.id==='zoomModal')closeZoom()})} function renderView(id){if(id==='summon')renderSummon();if(id==='collection')renderCollection();if(id==='rides')renderRides();if(id==='estates')renderEstates();if(id==='shop')renderShop();if(id==='database')renderDatabase();if(id==='editor')renderEditor();if(id==='settings')renderSettings()} function init(){loadDB();loadUIState();
initTabs();
bindZoom();$('#btnSave').onclick=saveDB;$('#btnExport').onclick=exportDB;$('#btnReset').onclick=resetDB;$('#importFile').addEventListener('change',(e)=>{const file=e.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=()=>{try{DB=JSON.parse(reader.result);saveDB();renderAll();alert('Imported save.')}catch(err){alert('Invalid JSON.')}};reader.readAsText(file)});enableCurrencyEdit()} document.addEventListener('DOMContentLoaded',init); </script> 
<script>
// --- Fix for search typing and Enter key filtering ---
document.addEventListener('DOMContentLoaded', () => {
  // Enable typing in all text inputs
  document.querySelectorAll('input[type="text"]').forEach(inp => {
    inp.removeAttribute('readonly');
    inp.style.pointerEvents = 'auto';
    inp.addEventListener('keydown', e => e.stopPropagation());
    inp.addEventListener('click', e => e.stopPropagation());
    inp.addEventListener('focus', e => e.stopPropagation());
  });

  // Add Enter key behavior for search in Collection and Database
  const dbSearch = document.getElementById('dbQuery');
  const colSearch = document.getElementById('colQuery');

  if (dbSearch) {
    dbSearch.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        renderDatabase();
      }
    });
  }
  if (colSearch) {
    colSearch.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        renderCollection();
      }
    });
  }
});
</script>


<script>
// --- Global Keyboard Typing Fix ---
window.addEventListener('keydown', function(e) {
  const el = e.target;
  if (el && (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' || el.isContentEditable)) {
    e.stopImmediatePropagation();
    return;
  }
}, true);
</script>


<script>
// --- Debounced Search Input Fix ---
let dbTimer, colTimer;
function debouncedRender(which){
  if(which==='db'){clearTimeout(dbTimer); dbTimer=setTimeout(renderDatabase, 500);}
  else if(which==='col'){clearTimeout(colTimer); colTimer=setTimeout(renderCollection, 500);}
  else if(which==='rides'){clearTimeout(dbTimer); dbTimer=setTimeout(renderRides, 500);}
  else if(which==='estates'){clearTimeout(colTimer); colTimer=setTimeout(renderEstates, 500);}
}
</script>


<!-- Build: The Collector v3.7 (Final Release, Persistent UI & Optimized) -->

<!-- Build: The Collector v3.7 (Final Release, Persistent UI & Optimized) -->

<!-- Build: The Collector v3.7 (Final Release, Persistent UI & Optimized) -->
</body></html>